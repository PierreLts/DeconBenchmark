#!/bin/bash
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=8
#SBATCH --mem=32G
#SBATCH --time=1:00:00
#SBATCH --output=/scratch/lorthiois/logs/%A.o
#SBATCH --error=/scratch/lorthiois/logs/%A.e
#SBATCH --job-name=paired_benchmarking

### Useful for debugging
set -e # Exit the script if any statement returns a non-true return value
set -x # Print each line of code being computed

RLIBRARY="/work/gr-fe/R_4.3.1" # R library path
SCRIPT_STATS=/work/gr-fe/lorthiois/DeconBenchmark/scripts/benchmark/paired_model_stats.R
SCRIPT_PLOT=/work/gr-fe/lorthiois/DeconBenchmark/scripts/benchmark/paired_cell_proportion_plot.R

PER_SAMPLE_GT="/work/gr-fe/lorthiois/DeconBenchmark/generated_data/per_sample_ground_truth_proportions.rda"
GENERAL_GT="/work/gr-fe/lorthiois/DeconBenchmark/generated_data/ground_truth_proportions.rda"
RESULTS="/work/gr-fe/lorthiois/DeconBenchmark/deconv_results/results_MuSic_Batch1.rda"
OUTPUT_DIR="/work/gr-fe/lorthiois/DeconBenchmark/paired_benchmark_results"

# Extract method and data names from the results filename
RESULTS_FILENAME=$(basename "${RESULTS}")
METHOD=$(echo "${RESULTS_FILENAME}" | sed -E 's/results_([^_]+)_.+\.rda/\1/')
DATA=$(echo "${RESULTS_FILENAME}" | sed -E 's/results_[^_]+_(.+)\.rda/\1/')

# Create method-specific output directory
METHOD_OUTPUT_DIR="${OUTPUT_DIR}/${METHOD}_${DATA}"
mkdir -p ${METHOD_OUTPUT_DIR}

module use /work/scitas-share/spack-r-gr-fe/share/spack/lmod/linux-rhel8-x86_64/Core/
module load r

start=`date +%s`
echo "START AT $(date)"

# Run paired benchmarking
Rscript ${SCRIPT_STATS} ${RLIBRARY} ${PER_SAMPLE_GT} ${GENERAL_GT} ${RESULTS} ${METHOD_OUTPUT_DIR}

# The mapping file is generated by the paired_model_stats.R script
# The exact path should match what's in the R script
MAPPING_FILE="${METHOD_OUTPUT_DIR}/${METHOD}_${DATA}_sample_mapping.csv"

# Verify if mapping file exists
if [ -f "$MAPPING_FILE" ]; then
    echo "Mapping file found at: $MAPPING_FILE"
    ls -la "$MAPPING_FILE"
    Rscript ${SCRIPT_PLOT} ${RLIBRARY} ${PER_SAMPLE_GT} ${GENERAL_GT} ${RESULTS} ${MAPPING_FILE} ${METHOD_OUTPUT_DIR}
else
    echo "ERROR: Mapping file not found at: $MAPPING_FILE"
    echo "Contents of output directory:"
    ls -la "${METHOD_OUTPUT_DIR}"
fi

# Print end date and echo total runtime
end=`date +%s`
runtime=$((end-start))
echo "Runtime: $runtime seconds"
echo "Paired benchmarking results saved to: ${METHOD_OUTPUT_DIR}"